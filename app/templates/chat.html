<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <title>AI Support Chat</title>
  <style>
    #messages::-webkit-scrollbar {
      width: 8px;
    }
    #messages::-webkit-scrollbar-track {
      background: #2d2d2d;
      border-radius: 8px;
    }
    #messages::-webkit-scrollbar-thumb {
      background-color: #555;
      border-radius: 8px;
      border: 2px solid #2d2d2d;
    }
    #messages::-webkit-scrollbar-thumb:hover {
      background: #888;
    }
  </style>
</head>
<body class="bg-gray-900 text-white">
  <!-- Chat Toggle Button -->
  <div class="fixed bottom-4 right-6 z-50">
    <button id="toggleChat" class="bg-blue-600 hover:bg-blue-700 p-4 rounded-full shadow-lg">
      ðŸ’¬
    </button>
  </div>

  <!-- Chat Box -->
  <div id="chatBox" class="hidden fixed bottom-20 right-6 w-full max-w-md h-[32rem] bg-gray-800 rounded-xl shadow-lg flex flex-col overflow-hidden">
    <div class="bg-gray-700 px-4 py-2 font-bold">Support</div>

    <div id="messages" class="flex-1 overflow-y-auto p-4 space-y-2">
      <div class="break-words whitespace-pre-wrap px-4 py-2 rounded-lg text-sm max-w-[75%] w-fit bg-gray-700 self-start text-left mr-auto">ðŸ‘‹ Hi! Iâ€™m your AI assistant, built by Mykola C. I can help you explore how AI and automation might work in your business. All work is done via UpWork.
What would you like to know?</div>
    </div>

    <div class="flex border-t border-gray-700">
      <input
        id="chatInput"
        type="text"
        placeholder="Type a message..."
        class="w-full bg-gray-900 text-white px-4 py-2 outline-none resize-none overflow-hidden"
      />
      <button id="sendBtn" class="bg-blue-600 hover:bg-blue-700 px-4 text-white">â†’</button>
    </div>
  </div>

  <script>
    const toggleBtn = document.getElementById('toggleChat');
    const chatBox = document.getElementById('chatBox');
    const messages = document.getElementById('messages');
    const input = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');

    toggleBtn.addEventListener('click', () => {
      chatBox.classList.toggle('hidden');
    });

    function addMessage(content, sender = 'user', isLoading = false) {
      const msg = document.createElement('div');
      msg.className = `break-words whitespace-pre-wrap px-4 py-2 rounded-lg text-sm max-w-[75%] w-fit ` +
        (sender === 'user'
          ? 'bg-blue-600 self-end text-right ml-auto'
          : 'bg-gray-700 self-start text-left mr-auto');

      if (isLoading) msg.classList.add('animate-pulse');
      msg.textContent = content.trim();
      messages.appendChild(msg);
      messages.scrollTop = messages.scrollHeight;
      return msg;
    }

    let lastTypingElement = null;

    async function sendMessage() {
      const text = input.value.trim();
      if (!text) return;
      addMessage(text, 'user');
      input.value = '';

      if (lastTypingElement) {
        lastTypingElement.remove();
        lastTypingElement = null;
      }

      lastTypingElement = addMessage('Typing response...', 'bot', true);

      try {
        const res = await fetch('/api/v1/chat', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ message: text })
        });

        const data = await res.json();
        lastTypingElement.textContent = data.response || 'No response.';
        lastTypingElement.classList.remove('animate-pulse');
        lastTypingElement = null;
      } catch (error) {
        lastTypingElement.textContent = 'Error fetching response.';
        lastTypingElement.classList.remove('animate-pulse');
        lastTypingElement = null;
        console.error(error);
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') sendMessage();
    });
  </script>
</body>
</html>
